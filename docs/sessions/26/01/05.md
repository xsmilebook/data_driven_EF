# 2026-01-05 会话记录

## 变更目的
补充 task-fMRI 的 xcp-d（`xcp_d-0.10.0`）处理流程文档，形成可直接复现的工程说明与参数口径记录。

## 修改内容
- 新增流程说明文档：`docs/reports/task_fmri_xcpd_pipeline.md`（详细描述 task regressors 的构建、xcp-d 参数与常见报错处理）。
- 更新 SST 的 block/state 回归量提取逻辑：兼容 120 试次（单 block）与 180 试次（双 block，90/91 之间注视间隔），并在存在 `Trial_loop_list` 时优先使用 loop1/loop2 识别 block。
- 将 xcp-d 容器升级到 `xcp_d-0.10.0`，并按官方 CLI 模式改为 `--datasets custom=...` + YAML confounds 配置注入 task regressors；同时增加 FreeSurfer subjects dir 的 bind（`SUBJECTS_DIR=/freesurfer`）。
- 由于 `xcp_d-0.10.0` 要求 `--fd-thresh` 为非负数，将其设为 `100` 以避免实际 scrubbing（同时满足参数约束）。
- 统一 rest 与 task 的 xcp-d 参数（与已验证可运行的参考配置一致）：`--output-type censored`、`--create-matrices all`、`--head-radius 50`、`--bpf-order 2`、`--resource-monitor`、`--smoothing 2`、`--despike n`。
- 根据已验证可运行的配置，将 task-fMRI 的 `--file-format` 改为 `cifti`，并将 `--min-coverage` 设为 `0`。
- 将 rest 的 `xcpd_36p.sh` 同步为 `--file-format cifti` 与 `--min-coverage 0`，与 task-fMRI 的输出格式保持一致。
- 修复 xcp-d 对 custom confounds dataset 的 BIDS-derivatives 校验：为 `dataset_description.json` 补充 `GeneratedBy.Name` 字段（避免 `BIDSDerivativesValidationError`）。
- 新增写死路径、可直接分享运行的 task-fMRI xcp-d 直接脚本：
  - 单被试单任务：`temp/run_xcpd_task_direct.sh`
  - 批量提交：`temp/batch_run_xcpd_task_direct.sh`
- 在 `docs/workflow.md` 与 `docs/reports/task_fmri_xcpd_pipeline.md` 补充上述“直接脚本”入口说明。
