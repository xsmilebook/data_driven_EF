# 2026-01-04 会话记录

## 变更目的
将 EFNY 行为任务的选择数（2AFC vs 多选）与可用序贯采样模型严格对齐，并把最新建模决策与后续计算规划同步写入文档与计划文件。

## 主要结论（建模决策）
- `ColorStroop`、`EmotionStroop`：原始为 4-choice，主模型为 **4-choice 多选 SSM（HSSM: `race_no_z_4`；作为 LBA4 的可行替代）**；报告层面将响应归并为 Target / Word / Other（其中 EmotionStroop 仍需补齐 target/word 映射信息）。
- `DT`、`EmotionSwitch`：原始为 4-choice，但可通过轴向/维度重编码得到两个 2-choice 子任务后使用 **2-choice 层级 DDM**；建议在同一模型中联合估计 Mixing + Switch，并加入 axis/dimension 控制项。
- `SST`：补充 **go-only 2AFC DDM**（仅 go trials），并将 stop 抑制解释与 SSRT/race 模型并列呈现（不在 DDM 主表内替代）。
- 层级结构目标：对 DDM 的 `v/a/t/z` 引入被试随机效应；默认仅允许 `v` 具有条件效应（FLANKER 可做 `a ~ congruency` 的敏感性分析）。
- 可追溯性：每个 `task×model` 保存 posterior traces（`InferenceData` netcdf）与轻量 summary，便于集群计算后下载到本地复核与汇总。

## 修改内容
- 更新决策报告：`docs/reports/ddm_decision.md`（新增/细化 2-choice 重编码与 LBA 报表归并规则）。
- 更新工程流程说明：`docs/workflow.md`（补充 LBA、2-choice 重编码、go-only DDM 与 traces/summaries 的输出约定）。
- 更新计划文件：`PLAN.md`（将上述决策转化为可执行的全样本建模与 SLURM 计算计划）。
- 更新进度记录：`PROGRESS.md`。
- 更新数据规范化脚本：`src/behavioral_preprocess/app_data/format_app_data.py`（删除 Emotion1Back/Emotion2Back 的参考列替换修复，仅保留 SST 的 SSRT 参考修复）。
- 补充 DT/EmotionSwitch 的对照模型设计：在 `docs/reports/ddm_decision.md` 与 `PLAN.md` 中明确两个并行模型（Mixing vs Switch），并将 `a/t0` 与 `v` 一起设为随条件变化（含 `rule` 交互）。
- 实现可在 SLURM 上直接运行的建模脚本（保存 traces/summaries 到 `data/processed/table/metrics/ssm/`）：
  - 2AFC DDM：`scripts/fit_ssm_task.py` + `scripts/submit_hpc_ssm.sh`
  - 4-choice 多选 SSM：`scripts/fit_race4_task.py` + `scripts/submit_hpc_race4.sh`
  - 汇总工具：`scripts/collect_ssm_results.py`
- 将 `scripts/ddm_decision_report.py` 标记为 legacy，并默认禁止覆盖现有 `docs/reports/ddm_decision.md`（需显式 `--force` 才允许写回）。

## 复现与下一步
- 当前文档更新不依赖运行；后续按 `PLAN.md` 实现脚本后，统一入口仍为 `python -m scripts.<entry> --dataset EFNY --config configs/paths.yaml`。
- 关键阻塞点：EmotionStroop 的 “target vs word” 映射来源需确认（Excel 显式字段或外部刺激字典）。

## task-fMRI xcp-d 会话记录（去噪 + 去除任务诱发 HRF）

### 变更目的
为 Tsinghua task-fMRI（NBACK/SST/SWITCH）在已完成 fMRIPrep 的前提下，增加可批量提交的 xcp-d 后处理脚本：在 36P + 0.01–0.1 Hz 去噪基础上，将任务诱发 HRF（block/state + event）作为 confounds 一并回归，以获得更接近 resting-state 的残差时序用于下游分析。

### 行为记录结构要点（Psychopy CSV）
- 扫描起点：优先使用 `MRI_Signal_s.started` 作为时间 0。
- NBACK/SWITCH：试次行中 `Task_img` 常为空，block/state 需要通过 `Trial_loop_list` 推断（如 `0back_block*`、`nonswitch1_trial_loop` 等）。
- SWITCH：`nonswitch1`/`nonswitch2` 分别对应纯 red/纯 blue，`switch` 对应 mixed。
- SST：共 120 试次，按 `Trial_loop.thisTrialN < 60` 划分 `part1/part2`；按键 onset 用 `key_resp.started + key_resp.rt`。

### 实现与文件
- 新增 task confounds 生成入口：`scripts/build_task_xcpd_confounds.py`（输出与 fMRIPrep confounds TSV 同名的 task 回归量 TSV，供 xcp-d `--custom_confounds` 自动匹配加载）。
- 新增 xcp-d 提交脚本：`src/imaging_preprocess/xcpd_task_36p_taskreg.sh`（容器版本固定为 `xcpd-0.7.1rc5`）。
- 新增批处理脚本：`src/imaging_preprocess/batch_run_xcpd_task.sh`（按被试列表×任务提交 SLURM jobs）。
- 新增配置文件：`configs/dataset_tsinghua_taskfmri.yaml`（集中配置 `task_psych_dir` 与各任务 fMRIPrep 根目录）。
- 更新流程文档：`docs/workflow.md`、`docs/methods.md`（补充 task-fMRI xcp-d 的回归口径与运行方式）。
- 新增被试列表生成入口：`scripts/build_taskfmri_sublist.py`（从 `task_psych_dir` 扫描并写出 `data/processed/table/sublist/taskfmri_sublist.txt`）。
- 将 task-fMRI 被试列表统一为 **不包含** `sub-` 的 BIDS participant label（xcp-d 的 `--participant_label` 需要该格式；fMRIPrep 文件名中的 `sub-` 前缀由路径与匹配逻辑处理）。
- 兼容 `xcpd-0.7.1rc5` CLI：task 回归量通过 `--custom_confounds <folder>` 注入（文件名需与对应 fMRIPrep `*_desc-confounds_timeseries.tsv` basename 一致），并与 `--nuisance-regressors 36P` 叠加回归。
