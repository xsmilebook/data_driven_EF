# 2026-01-13

## 本次目标

- 基于 CIBR app 行为工作簿生成两套一致性分组：按 `正式阶段刺激图片/Item名` 与按 `正式阶段正确答案`（均允许缺失 sheet，仅比较共同存在任务）。

## 修改内容

- 更新临时分组脚本：`temp/group_app_stimulus_groups.py`
  - 支持两种分组口径：`--grouping answer` 与 `--grouping item`。
  - 继续保留 SST 97 行异常处理：若 `SST` sheet 行数为 97，则丢弃最后一行后再进入比较。
- 清理临时验证产物：删除 `temp/smoke_*` 等 smoke-test 输出目录，并将“验证后及时清理 `temp/` 下测试产物”的规则写入 `AGENTS.md`。
- 重新生成分组输出（分别一套目录）：
  - `data/interim/behavioral_preprocess/groups_by_answer/`
  - `data/interim/behavioral_preprocess/groups_by_item/`
- 更新流程文档：`docs/workflow.md`（补充两套分组的运行方式与输出目录）。
- 在 `PLAN.md` 新增 APP 数据问题分析与推断修正计划，明确后续将生成“刺激序列与正确答案均更正”的新数据集（新目录、不覆盖原始工作簿），并补充需要量化输出的异常统计与验证口径。
- 新增基于 visit 配置的更正脚本：`scripts/correct_app_workbooks.py`（使用 `data/raw/behavior_data/app_sequence/` 推断并更正每位被试工作簿的刺激与正确答案序列）。
- 生成更正版数据集（不覆盖原始）：`data/processed/behavior_data/cibr_app_data_corrected_excel/run_corrected_v1/subjects/`，并输出 `manifest.csv` 与逐被试 `decisions/*.json` 便于追溯。
- 更正脚本已覆盖多任务刺激编码字段：除 `*PicName` 外，额外解析 `picData`（例如 FZSS/DT/NBack 等任务），确保刺激序列可从配置中正确重建。
- 新增更正报告：`docs/reports/app_sequence_correction_report.md`（汇总导出链路问题、时间线先验、推断策略与全样本统计）。

## 运行命令

```bash
python temp/group_app_stimulus_groups.py --dataset EFNY --config configs/paths.yaml --grouping answer
python temp/group_app_stimulus_groups.py --dataset EFNY --config configs/paths.yaml --grouping item

python -m scripts.correct_app_workbooks --dataset EFNY --config configs/paths.yaml --run-id corrected_v1
```
